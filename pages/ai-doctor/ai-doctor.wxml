<!--AIåŠ©æ‰‹æ™ºèƒ½åŒ»ç”Ÿé¡µé¢-->
<nav-sidder visible="{{sidderVisible}}" bind:onClose="handleSidderToggle" bind:onMaskClick="handleSidderToggle">
  <!-- ä¾§è¾¹æ å†…å®¹ -->
  <view slot="sidderContent" class="sidder__content">
    <!-- å†å²å¯¹è¯åˆ—è¡¨ -->
    <view class="session-history">
      <view class="session-history__title">
        <view class="tabs">
          <text class="title active">å¯¹è¯</text>
        </view>
      </view>

      <!-- å¯¹è¯åˆ—è¡¨å†…å®¹ -->
      <view class="tabs-content">
        <scroll-view
          class="session-history__content"
          scroll-y="{{true}}"
          wx:if="{{conversations.length > 0}}">
          <view class="session-history__list" wx:for="{{conversations}}" wx:for-item="historyPeriodItem" wx:key="index">
            <text class="period">{{historyPeriodItem.period}}</text>
            <view
              class="session-history__item {{currentConvId === historyItem.id ? 'selected' : ''}}"
              wx:for="{{historyPeriodItem.list}}"
              wx:for-item="historyItem"
              wx:key="id"
              bindtap="loadConversation"
              data-id="{{historyItem.id}}">
              <view class="item-info">
                <view class="item-info__name">
                  <view class="item-info__text">{{historyItem.title}}</view>
                </view>
                <view class="item-info__msg">
                  <view class="item-info__text">{{historyItem.lastMessage}}</view>
                  <text class="item-label">{{historyItem.lastUpdateTime}}</text>
                </view>
              </view>
            </view>
          </view>
        </scroll-view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="session-history__empty" wx:else>
          <view class="session-history__empty__icon">
            <text class="empty-icon">ğŸ’¬</text>
          </view>
          <view class="session-history__empty__text">å¿«å»å¼€å¯å¯¹è¯å§~</view>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view slot="mainContent" class="container" style="padding-top: {{navHeight}}px;">
  <!-- ä¸‹æ‹‰æ¡†é®ç½© -->
  <view class="dropdown-mask" wx:if="{{showNewConvDropdown}}" bindtap="closeNewConvDropdown"></view>

  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-navbar" style="height: {{navHeight}}px; padding-top: {{statusBarHeight}}px;">
    <!-- å·¦ä¾§å†å²æŒ‰é’® -->
    <view class="nav-left-btn {{sidderVisible ? 'nav-left-btn--close' : ''}}" bindtap="handleSidderToggle">
      <image wx:if="{{!sidderVisible}}" class="nav-icon-img" src="../../images/history.png" mode="aspectFit"></image>
      <image wx:else class="nav-icon-img" src="../../images/cancel.png" mode="aspectFit"></image>
    </view>

    <!-- ä¸­é—´æ ‡é¢˜å’Œæ–°å»ºå¯¹è¯æŠ˜å æ¡† -->
    <view class="nav-center">
      <view class="nav-title-wrapper" bindtap="toggleNewConvDropdown">
        <text class="nav-title">AIæ™ºèƒ½åŒ»ç”Ÿ</text>
        <text class="nav-dropdown-icon {{showNewConvDropdown ? 'nav-dropdown-icon--up' : ''}}">â–¼</text>
      </view>

      <!-- æ–°å»ºå¯¹è¯æŠ˜å æ¡† -->
      <view class="new-conv-dropdown {{showNewConvDropdown ? 'new-conv-dropdown--show' : ''}}" wx:if="{{showNewConvDropdown}}">
        <view class="dropdown-item" bindtap="startNewConv">
          <text class="dropdown-text">å¼€å§‹æ–°å¯¹è¯</text>
        </view>
      </view>
    </view>

    <!-- å³ä¾§å ä½ï¼Œä¿æŒå¸ƒå±€å¹³è¡¡ -->
    <view class="nav-right-placeholder"></view>
  </view>

  <!-- å¥åº·æ•°æ®æ¦‚è§ˆ - ç§»åˆ°é¡¶éƒ¨ -->
  <view class="health-overview-top">
    <text class="overview-title">å½“å‰å¥åº·æ•°æ®</text>
    <view class="data-cards">
      <view class="data-card">
        <text class="data-label">å‘¼å¸</text>
        <text class="data-value">{{monitorData.breathing.value || '--'}}æ¬¡/åˆ†</text>
        <view class="status-dot {{monitorData.breathing.status}}"></view>
      </view>
      <view class="data-card">
        <text class="data-label">å¿ƒè·³</text>
        <text class="data-value">{{monitorData.heartRate.value || '--'}}æ¬¡/åˆ†</text>
        <view class="status-dot {{monitorData.heartRate.status}}"></view>
      </view>
      <view class="data-card">
        <text class="data-label">è¡€æ°§</text>
        <text class="data-value">{{monitorData.bloodOxygen.value || '--'}}%</text>
        <view class="status-dot {{monitorData.bloodOxygen.status}}"></view>
      </view>
    </view>
  </view>

  <!-- èŠå¤©åŒºåŸŸ -->
  <scroll-view class="chat-section" scroll-y scroll-into-view="{{scrollIntoView}}" style="height: 910rpx; display: block; box-sizing: border-box">

    <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
    <view class="chat-messages">
      <view class="message-item {{item.role}}" wx:for="{{messages}}" wx:key="id">
        <view class="message-avatar">
          <text class="avatar-text">{{item.role === 'user' ? 'æˆ‘' : 'AI'}}</text>
        </view>
        <view class="message-content {{item.isStreaming ? 'streaming' : ''}}">
          <text class="message-text" user-select>{{item.content}}</text>
          <text class="message-time">{{item.time}}</text>
        </view>
      </view>

      <!-- æ€è€ƒä¸­çŠ¶æ€ -->
      <view class="loading-message" wx:if="{{thinkingStatus === 'thinking'}}">
        <view class="message-avatar">
          <text class="avatar-text">AI</text>
        </view>
        <view class="message-content thinking-content">
          <text class="thinking-text">æ€è€ƒä¸­</text>
          <text class="thinking-subtitle">æ­£åœ¨ç”¨å¿ƒè§£æä½ çš„éœ€æ±‚</text>
          <view class="loading-spinner"></view>
        </view>
      </view>

      <!-- æ¢³ç†ä¸­çŠ¶æ€ -->
      <view class="loading-message" wx:if="{{thinkingStatus === 'organizing'}}">
        <view class="message-avatar">
          <text class="avatar-text">AI</text>
        </view>
        <view class="message-content organizing-content">
          <text class="thinking-text">æ¢³ç†ä¸­</text>
          <text class="thinking-subtitle">æ­£åœ¨æ¢³ç†ä¿¡æ¯ï¼Œç¡®è®¤ä½ çš„éœ€æ±‚</text>
          <view class="loading-spinner"></view>
        </view>
      </view>

      <!-- é¢„åˆ¶å›ç­”é€‰é¡¹ -->
      <view class="preset-suggestions" wx:if="{{messages.length <= 1}}">
        <view class="suggestion-item" bindtap="sendPresetMessage" data-message="åˆ†ææˆ‘çš„å¥åº·æ•°æ®">
          <text class="suggestion-text">åˆ†ææˆ‘çš„å¥åº·æ•°æ®</text>
          <view class="suggestion-arrow">></view>
        </view>
        <view class="suggestion-item" bindtap="sendPresetMessage" data-message="ç»™æˆ‘ä¸€äº›å¥åº·å»ºè®®">
          <text class="suggestion-text">ç»™æˆ‘ä¸€äº›å¥åº·å»ºè®®</text>
          <view class="suggestion-arrow">></view>
        </view>
        <view class="suggestion-item" bindtap="sendPresetMessage" data-message="æˆ‘çš„æ•°æ®æ­£å¸¸å—">
          <text class="suggestion-text">æˆ‘çš„æ•°æ®æ­£å¸¸å—ï¼Ÿ</text>
          <view class="suggestion-arrow">></view>
        </view>
      </view>



      <!-- æ»šåŠ¨é”šç‚¹ -->
      <view id="bottom"></view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-section-bottom">
    <view class="input-container-coffee">
      <view class="input-wrapper-coffee">
        <input class="message-input-coffee"
               placeholder="è¯·è¾“å…¥æ‚¨çš„å¥åº·é—®é¢˜ ..."
               value="{{inputText}}"
               bindinput="onInputChange"
               bindconfirm="sendMessage"
               confirm-type="send"
               maxlength="500" />
      </view>
      <view class="send-btn-coffee {{inputText ? 'active' : ''}}"
            bindtap="sendMessage">
        <image class="send-icon" src="/images/send.png" wx:if="{{inputText}}"></image>
        <text class="send-text" wx:else>å‘é€</text>
      </view>
    </view>
  </view>
  </view>
</nav-sidder>
