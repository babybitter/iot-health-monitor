<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©è”ç½‘ç›‘æµ‹ç³»ç»Ÿ - æ•°æ®ç®¡ç†åå°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .header h1 { margin-bottom: 10px; }
        .status { display: flex; gap: 20px; margin-top: 15px; }
        .status-item { background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 5px; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .data-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .data-value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .data-label { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .chart-container { height: 300px; margin: 20px 0; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn:hover { opacity: 0.8; }
        .table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: bold; }
        .alert { padding: 10px; border-radius: 5px; margin: 5px 0; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .alert-critical { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { text-align: center; padding: 20px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨çŠ¶æ€ -->
        <div class="header">
            <h1>ğŸ¥ ç‰©è”ç½‘ç›‘æµ‹ç³»ç»Ÿ - æ•°æ®ç®¡ç†åå°</h1>
            <p>å®æ—¶ç›‘æµ‹æ•°æ®å­˜å‚¨ä¸å†å²è®°å½•æŸ¥çœ‹</p>
            <div class="status">
                <div class="status-item">
                    <strong>æ•°æ®åº“:</strong> <span id="db-status">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="status-item">
                    <strong>MQTT:</strong> <span id="mqtt-status">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="status-item">
                    <strong>æœ€åæ›´æ–°:</strong> <span id="last-update">--</span>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="btn btn-success" onclick="insertTestData()">ğŸ§ª æ’å…¥æµ‹è¯•æ•°æ®</button>
            <button class="btn btn-warning" onclick="exportData()">ğŸ“Š å¯¼å‡ºæ•°æ®</button>
            <select id="time-range" onchange="loadHistoryData()">
                <option value="1">æœ€è¿‘1å°æ—¶</option>
                <option value="6">æœ€è¿‘6å°æ—¶</option>
                <option value="24" selected>æœ€è¿‘24å°æ—¶</option>
                <option value="168">æœ€è¿‘7å¤©</option>
            </select>
        </div>

        <!-- æ•°æ®å¡ç‰‡ -->
        <div class="cards">
            <!-- æœ€æ–°æ•°æ® -->
            <div class="card">
                <h3>ğŸ“Š æœ€æ–°ç›‘æµ‹æ•°æ®</h3>
                <div class="data-grid" id="latest-data">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å‘Šè­¦ä¿¡æ¯ -->
            <div class="card">
                <h3>ğŸš¨ æœ€æ–°å‘Šè­¦</h3>
                <div id="alerts-list">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="card">
            <h3>ğŸ“ˆ å†å²è¶‹åŠ¿å›¾</h3>
            <div class="chart-container">
                <canvas id="trend-chart"></canvas>
            </div>
        </div>

        <!-- å†å²æ•°æ®è¡¨æ ¼ -->
        <div class="card">
            <h3>ğŸ“‹ å†å²æ•°æ®è®°å½•</h3>
            <div style="overflow-x: auto;">
                <table class="table" id="history-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>æ¸©åº¦(Â°C)</th>
                            <th>æ¹¿åº¦(%)</th>
                            <th>CO2(ppm)</th>
                            <th>å‘¼å¸é¢‘ç‡</th>
                            <th>è¡€æ°§(%)</th>
                            <th>å…‰ç…§(lux)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let trendChart = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
            loadLatestData();
            loadAlerts();
            loadHistoryData();
            initChart();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(() => {
                loadLatestData();
                loadAlerts();
            }, 30000);
        });

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/health');
                const result = await response.json();
                
                document.getElementById('db-status').textContent = result.status.database;
                document.getElementById('mqtt-status').textContent = result.status.mqtt;
                document.getElementById('last-update').textContent = result.status.timestamp;
            } catch (error) {
                console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // åŠ è½½æœ€æ–°æ•°æ®
        async function loadLatestData() {
            try {
                const response = await fetch('/api/latest');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    document.getElementById('latest-data').innerHTML = `
                        <div class="data-item">
                            <div class="data-value">${data.temperature || '--'}</div>
                            <div class="data-label">æ¸©åº¦(Â°C)</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">${data.humidity || '--'}</div>
                            <div class="data-label">æ¹¿åº¦(%)</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">${data.co2 || '--'}</div>
                            <div class="data-label">CO2(ppm)</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">${data.breathing_rate || '--'}</div>
                            <div class="data-label">å‘¼å¸é¢‘ç‡</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">${data.spo2 || '--'}</div>
                            <div class="data-label">è¡€æ°§(%)</div>
                        </div>
                        <div class="data-item">
                            <div class="data-value">${data.light_intensity || '--'}</div>
                            <div class="data-label">å…‰ç…§(lux)</div>
                        </div>
                    `;
                } else {
                    document.getElementById('latest-data').innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                }
            } catch (error) {
                console.error('åŠ è½½æœ€æ–°æ•°æ®å¤±è´¥:', error);
                document.getElementById('latest-data').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½å‘Šè­¦ä¿¡æ¯
        async function loadAlerts() {
            try {
                const response = await fetch('/api/alerts?limit=5');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const alertsHtml = result.data.map(alert => `
                        <div class="alert alert-${alert.alert_level}">
                            <strong>${alert.alert_type}:</strong> ${alert.alert_message}
                            <small style="float: right;">${moment(alert.created_at).format('MM-DD HH:mm')}</small>
                        </div>
                    `).join('');
                    document.getElementById('alerts-list').innerHTML = alertsHtml;
                } else {
                    document.getElementById('alerts-list').innerHTML = '<div class="loading">æš‚æ— å‘Šè­¦</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å‘Šè­¦å¤±è´¥:', error);
            }
        }

        // åŠ è½½å†å²æ•°æ®
        async function loadHistoryData() {
            const hours = document.getElementById('time-range').value;
            const endTime = new Date();
            const startTime = new Date(endTime.getTime() - hours * 60 * 60 * 1000);
            
            try {
                const response = await fetch(`/api/history?limit=100&start_time=${startTime.toISOString()}&end_time=${endTime.toISOString()}`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    // æ›´æ–°è¡¨æ ¼
                    const tbody = document.querySelector('#history-table tbody');
                    tbody.innerHTML = result.data.map(row => `
                        <tr>
                            <td>${moment(row.created_at).format('MM-DD HH:mm:ss')}</td>
                            <td>${row.temperature || '--'}</td>
                            <td>${row.humidity || '--'}</td>
                            <td>${row.co2 || '--'}</td>
                            <td>${row.breathing_rate || '--'}</td>
                            <td>${row.spo2 || '--'}</td>
                            <td>${row.light_intensity || '--'}</td>
                        </tr>
                    `).join('');
                    
                    // æ›´æ–°å›¾è¡¨
                    updateChart(result.data);
                } else {
                    document.querySelector('#history-table tbody').innerHTML = '<tr><td colspan="7" class="loading">æš‚æ— æ•°æ®</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ¸©åº¦(Â°C)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'æ¹¿åº¦(%)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'CO2(ppm)',
                        data: [],
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // æ›´æ–°å›¾è¡¨
        function updateChart(data) {
            if (!trendChart) return;
            
            const labels = data.reverse().map(item => moment(item.created_at).format('HH:mm'));
            const temperatures = data.map(item => item.temperature);
            const humidities = data.map(item => item.humidity);
            const co2Values = data.map(item => item.co2);
            
            trendChart.data.labels = labels;
            trendChart.data.datasets[0].data = temperatures;
            trendChart.data.datasets[1].data = humidities;
            trendChart.data.datasets[2].data = co2Values;
            trendChart.update();
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            checkSystemStatus();
            loadLatestData();
            loadAlerts();
            loadHistoryData();
        }

        // æ’å…¥æµ‹è¯•æ•°æ®
        async function insertTestData() {
            try {
                const response = await fetch('/api/test-data', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert('æµ‹è¯•æ•°æ®æ’å…¥æˆåŠŸï¼');
                    refreshData();
                } else {
                    alert('æ’å…¥å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('æ’å…¥å¤±è´¥: ' + error.message);
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const hours = document.getElementById('time-range').value;
            const endTime = new Date();
            const startTime = new Date(endTime.getTime() - hours * 60 * 60 * 1000);
            
            const url = `/api/history?limit=1000&start_time=${startTime.toISOString()}&end_time=${endTime.toISOString()}`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
